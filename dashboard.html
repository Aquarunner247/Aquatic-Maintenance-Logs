<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquatic Venue Maintenance - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0077be 0%, #00a8e8 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #0066a1 0%, #0077be 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .property-tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; overflow-x: auto; }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: 500; color: #666; border-bottom: 3px solid transparent; transition: all 0.3s; white-space: nowrap; }
        .tab:hover { background: #e8e8e8; }
        .tab.active { color: #0077be; border-bottom-color: #0077be; background: white; }
        .content { padding: 30px; }
        .month-selector { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .month-selector label { font-weight: 600; color: #333; }
        .month-selector select { padding: 10px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; }
        .month-selector select:focus { outline: none; border-color: #0077be; }
        .table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; max-height: 600px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1600px; }
        thead { position: sticky; top: 0; z-index: 10; }
        th { background: #0077be; color: white; padding: 12px 8px; text-align: left; font-weight: 600; font-size: 11px; border-right: 1px solid rgba(255,255,255,0.2); }
        th:first-child { width: 50px; text-align: center; background: #0066a1; }
        td { padding: 6px; border-bottom: 1px solid #eee; border-right: 1px solid #f0f0f0; vertical-align: middle; }
        td:first-child { text-align: center; font-weight: 600; color: #0077be; background: #f8f9fa; position: sticky; left: 0; z-index: 5; }
        input[type="text"], input[type="number"], textarea, select { width: 100%; min-width: 100px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; transition: border-color 0.2s; background: white; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus { outline: none; border-color: #0077be; background: #e6f7ff; }
        textarea { min-height: 50px; min-width: 200px; resize: vertical; font-family: inherit; }
        .other-input { margin-top: 6px; }
        .actions { display: flex; gap: 15px; justify-content: space-between; flex-wrap: wrap; margin-top: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #0077be; color: white; }
        .btn-primary:hover { background: #0066a1; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 119, 190, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e0e0e0; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #10b981; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 1000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .property-info { background: #e6f7ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #91d5ff; }
        .property-info h3 { color: #0077be; margin-bottom: 15px; font-size: 18px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; }
        .info-item { display: flex; flex-direction: column; gap: 5px; }
        .info-item label { font-weight: 600; color: #0066a1; font-size: 13px; }
        .info-item input { padding: 8px; }
        @media (max-width: 768px) {
            .content { padding: 15px; }
            .header h1 { font-size: 22px; }
            .tab { padding: 12px 15px; font-size: 14px; }
            table { font-size: 11px; }
            th, td { padding: 4px 3px; }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification">Data saved successfully!</div>

    <div class="container">
        <div class="header">
            <h1>üèä Aquatic Venue Maintenance Dashboard</h1>
            <p>Data Entry & Management System</p>
        </div>

        <div class="property-tabs" id="propertyTabs"></div>

        <div class="content">
            <div class="property-info" id="propertyInfo"></div>

            <div class="month-selector">
                <label>üìÖ Month:</label>
                <select id="monthSelect">
                    <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                    <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                    <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>

                <label>Year:</label>
                <select id="yearSelect"></select>
            </div>

            <div class="table-wrapper">
                <table id="maintenanceTable"></table>
            </div>

            <div class="actions">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveData()">üíæ Save Data</button>
                    <!-- Clear Month removed as requested -->
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="exportData()">üì• Export All Data</button>
                    <button class="btn btn-secondary" onclick="viewQRCodes()">üì± View QR Codes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offscreen datalists container (keeps datalists usable across browsers without showing them) -->
    <div id="datalists" style="position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden;" aria-hidden="true"></div>

    <script>
        // Fields - ensure these match your Excel column names
        const FIELDS = [
            "DISINFECTANT RESIDUAL",
            "pH",
            "TOTAL ALKALINITY",
            "CYANURIC ACID",
            "WATER TEMPERATURE",
            "MICROBIOLOGICAL TESTING",
            "PUMP PRESSURE GAUGE (PSI)",
            "PUMP VACUUM GAUGE (inHg)",
            "ATTENDANCE",
            "REMARKS"
        ];

        // Range config per your request (these will be the select options)
        const RANGE_CONFIG = {
            "pH": { min: 7.4, max: 7.6, step: 0.1 },                 // 7.4, 7.5, 7.6
            "TOTAL ALKALINITY": { min: 60, max: 120, step: 10 },     // 60..120 step 10
            "CYANURIC ACID": { min: 30, max: 40, step: 5 },          // 30, 35, 40
            "WATER TEMPERATURE": { min: 70, max: 110, step: 1 }      // 70..110 step 1
        };

        // Attendance choices
        const CHOICES = { "ATTENDANCE": ["S.L", "R.A"] };

        const PROPERTIES = [
            { id: 'pool1', name: 'Pool #1', operator: '', operatorPhone: '', waterVolume: '', minFlow: '', maxFilterFlow: '' },
            { id: 'pool2', name: 'Pool #2', operator: '', operatorPhone: '', waterVolume: '', minFlow: '', maxFilterFlow: '' },
            { id: 'pool3', name: 'Pool #3', operator: '', operatorPhone: '', waterVolume: '', minFlow: '', maxFilterFlow: '' },
            { id: 'pool4', name: 'Pool #4', operator: '', operatorPhone: '', waterVolume: '', minFlow: '', maxFilterFlow: '' },
            { id: 'pool5', name: 'Pool #5', operator: '', operatorPhone: '', waterVolume: '', minFlow: '', maxFilterFlow: '' }
        ];

        let currentProperty = 'pool1';
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();

        function sanitizeFieldName(name) {
            return name.replace(/[^a-zA-Z0-9]/g, '_');
        }

        // Returns array of string values for a numeric range
        function generateNumericOptions(config) {
            const opts = [];
            const stepStr = String(config.step);
            const decimalPlaces = (stepStr.split('.')[1] || '').length;
            const scale = Math.pow(10, decimalPlaces);
            const minScaled = Math.round(config.min * scale);
            const maxScaled = Math.round(config.max * scale);
            const stepScaled = Math.round(config.step * scale);
            for (let v = minScaled; v <= maxScaled; v += stepScaled) {
                const raw = v / scale;
                opts.push(decimalPlaces > 0 ? raw.toFixed(decimalPlaces) : String(raw));
            }
            return opts;
        }

        // Build offscreen datalists for compatibility (not used by the select+other approach,
        // but kept so datalist-based inputs would work if added later)
        function buildDatalists() {
            const container = document.getElementById('datalists');
            container.innerHTML = '';
            FIELDS.forEach((field, idx) => {
                if (RANGE_CONFIG[field]) {
                    const dlId = `dl_${sanitizeFieldName(field)}_${idx}`;
                    const dl = document.createElement('datalist');
                    dl.id = dlId;
                    const opts = generateNumericOptions(RANGE_CONFIG[field]);
                    opts.forEach(o => {
                        const option = document.createElement('option');
                        option.value = o;
                        dl.appendChild(option);
                    });
                    container.appendChild(dl);
                }
            });
        }

        function init() {
            createPropertyTabs();
            populateYears();
            setCurrentDate();
            loadPropertyInfo();
            buildDatalists(); // keep datalists available offscreen
            renderTable();
            loadData();
        }

        function createPropertyTabs() {
            const tabsContainer = document.getElementById('propertyTabs');
            tabsContainer.innerHTML = '';
            PROPERTIES.forEach((prop, index) => {
                const tab = document.createElement('button');
                tab.className = 'tab' + (index === 0 ? ' active' : '');
                tab.textContent = prop.name;
                tab.onclick = () => switchProperty(prop.id);
                tabsContainer.appendChild(tab);
            });
        }

        function switchProperty(propertyId) {
            currentProperty = propertyId;
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                tab.classList.toggle('active', PROPERTIES[index].id === propertyId);
            });
            loadPropertyInfo();
            loadData();
        }

        function loadPropertyInfo() {
            const property = PROPERTIES.find(p => p.id === currentProperty);
            const infoDiv = document.getElementById('propertyInfo');

            infoDiv.innerHTML = `
                <h3>${property.name} Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Operator/Service Company:</label>
                        <input type="text" id="operator" value="${property.operator}" onchange="savePropertyInfo()">
                    </div>
                    <div class="info-item">
                        <label>Operator Phone #:</label>
                        <input type="text" id="operatorPhone" value="${property.operatorPhone}" onchange="savePropertyInfo()">
                    </div>
                    <div class="info-item">
                        <label>Water Volume (Gallons):</label>
                        <input type="text" id="waterVolume" value="${property.waterVolume}" onchange="savePropertyInfo()">
                    </div>
                    <div class="info-item">
                        <label>Minimum Required Flow (GPM):</label>
                        <input type="text" id="minFlow" value="${property.minFlow}" onchange="savePropertyInfo()">
                    </div>
                    <div class="info-item">
                        <label>Maximum Filter Flow (GPM):</label>
                        <input type="text" id="maxFilterFlow" value="${property.maxFilterFlow}" onchange="savePropertyInfo()">
                    </div>
                </div>
            `;
        }

        function savePropertyInfo() {
            const property = PROPERTIES.find(p => p.id === currentProperty);
            property.operator = document.getElementById('operator').value;
            property.operatorPhone = document.getElementById('operatorPhone').value;
            property.waterVolume = document.getElementById('waterVolume').value;
            property.minFlow = document.getElementById('minFlow').value;
            property.maxFilterFlow = document.getElementById('maxFilterFlow').value;
            localStorage.setItem('properties', JSON.stringify(PROPERTIES));
            showNotification('Property info saved!');
        }

        function populateYears() {
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            const currentYearLocal = new Date().getFullYear();
            for (let year = currentYearLocal - 2; year <= currentYearLocal + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function setCurrentDate() {
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth() + 1;
            document.getElementById('yearSelect').value = now.getFullYear();
            document.getElementById('monthSelect').onchange = () => { currentMonth = parseInt(document.getElementById('monthSelect').value); loadData(); };
            document.getElementById('yearSelect').onchange = () => { currentYear = parseInt(document.getElementById('yearSelect').value); loadData(); };
        }

        // Render table: for RANGE_CONFIG fields render select + "Other" text input (hidden) for custom values
        function renderTable() {
            const table = document.getElementById('maintenanceTable');
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            // Header
            let headerHTML = '<thead><tr><th>DAY</th>';
            FIELDS.forEach(field => headerHTML += `<th>${field}</th>`);
            headerHTML += '</tr></thead>';

            // Body
            let bodyHTML = '<tbody>';
            for (let day = 1; day <= 31; day++) {
                const isDisabled = day > daysInMonth;
                bodyHTML += `<tr ${isDisabled ? 'style="opacity:0.3"' : ''}>`;
                bodyHTML += `<td>${day}</td>`;

                FIELDS.forEach((field, fieldIndex) => {
                    const fieldId = `day${day}_field${fieldIndex}`;
                    const otherId = `day${day}_other_${fieldIndex}`;
                    const isRemarks = field.toUpperCase() === 'REMARKS';

                    if (isRemarks) {
                        bodyHTML += `<td><textarea id="${fieldId}" ${isDisabled ? 'disabled' : ''} placeholder="Enter remarks..."></textarea></td>`;
                        return;
                    }

                    // Non-numeric choices (attendance)
                    if (CHOICES[field] && Array.isArray(CHOICES[field])) {
                        let selectHTML = `<td><select id="${fieldId}" ${isDisabled ? 'disabled' : ''}>`;
                        selectHTML += `<option value=""></option>`;
                        CHOICES[field].forEach(choice => { selectHTML += `<option value="${choice}">${choice}</option>`; });
                        selectHTML += `</select></td>`;
                        bodyHTML += selectHTML;
                        return;
                    }

                    // Numeric range -> select + Other input
                    if (RANGE_CONFIG[field]) {
                        const opts = generateNumericOptions(RANGE_CONFIG[field]);
                        let selectHTML = `<td><div style="display:flex; gap:6px; align-items:center;"><select id="${fieldId}" ${isDisabled ? 'disabled' : ''} data-field-index="${fieldIndex}" onchange="handleSelectOtherChange('${fieldId}', '${otherId}', ${isDisabled})">`;
                        selectHTML += `<option value=""></option>`;
                        opts.forEach(o => { selectHTML += `<option value="${o}">${o}</option>`; });
                        selectHTML += `<option value="__other__">Other...</option>`;
                        selectHTML += `</select>`;
                        // hidden small input for custom value
                        selectHTML += `<input type="text" id="${otherId}" class="other-input" placeholder="Enter value" style="display:none; width:120px;" ${isDisabled ? 'disabled' : ''}>`;
                        selectHTML += `</div></td>`;
                        bodyHTML += selectHTML;
                        return;
                    }

                    // Fallback input
                    bodyHTML += `<td><input type="text" id="${fieldId}" ${isDisabled ? 'disabled' : ''}></td>`;
                });

                bodyHTML += '</tr>';
            }
            bodyHTML += '</tbody>';
            table.innerHTML = headerHTML + bodyHTML;
        }

        // When a select's value changes, show/hide the associated other input
        function handleSelectOtherChange(selectId, otherId, isDisabled) {
            const sel = document.getElementById(selectId);
            const other = document.getElementById(otherId);
            if (!sel || !other) return;
            if (sel.value === '__other__') {
                other.style.display = 'inline-block';
                other.disabled = !!isDisabled;
                other.focus();
                // Clear the select so saved value will come from the other input
                // (but keep the select set to __other__ so loadData can detect)
            } else {
                other.style.display = 'none';
                other.value = '';
            }
        }

        function getStorageKey() {
            return `${currentProperty}_${currentYear}_${currentMonth}`;
        }

        // Save: if select exists and value != __other__ -> save select.value.
        // If value == __other__ -> save value from 'other' input.
        function saveData() {
            const data = {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                data[day] = {};
                FIELDS.forEach((field, fieldIndex) => {
                    const selectEl = document.getElementById(`day${day}_field${fieldIndex}`);
                    const otherEl = document.getElementById(`day${day}_other_${fieldIndex}`);
                    const inputEl = document.getElementById(`day${day}_field${fieldIndex}`);
                    // Numeric-range cells use select + other input; attendance uses select; remarks use textarea; fallback input uses input
                    if (RANGE_CONFIG[field]) {
                        if (selectEl) {
                            if (selectEl.value === '__other__') {
                                data[day][field] = otherEl ? otherEl.value : '';
                            } else {
                                data[day][field] = selectEl.value;
                            }
                        }
                    } else if (CHOICES[field]) {
                        // attendance
                        const el = document.getElementById(`day${day}_field${fieldIndex}`);
                        if (el) data[day][field] = el.value;
                    } else if (field.toUpperCase() === 'REMARKS') {
                        const el = document.getElementById(`day${day}_field${fieldIndex}`);
                        if (el) data[day][field] = el.value;
                    } else {
                        const el = document.getElementById(`day${day}_field${fieldIndex}`);
                        if (el) data[day][field] = el.value;
                    }
                });
            }
            localStorage.setItem(getStorageKey(), JSON.stringify(data));
            showNotification('‚úÖ Data saved successfully!');
        }

        function loadData() {
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            currentYear = parseInt(document.getElementById('yearSelect').value);
            buildDatalists(); // rebuild offscreen datalists if needed
            renderTable();
            const saved = localStorage.getItem(getStorageKey());
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(day => {
                    FIELDS.forEach((field, fieldIndex) => {
                        const sel = document.getElementById(`day${day}_field${fieldIndex}`);
                        const other = document.getElementById(`day${day}_other_${fieldIndex}`);
                        const el = document.getElementById(`day${day}_field${fieldIndex}`);
                        if (RANGE_CONFIG[field]) {
                            const val = data[day][field] !== undefined ? data[day][field] : '';
                            // If val matches one of the options -> set select to val
                            const opts = generateNumericOptions(RANGE_CONFIG[field]);
                            if (opts.indexOf(val) !== -1) {
                                if (sel) { sel.value = val; if (other) { other.style.display = 'none'; other.value = ''; } }
                            } else if (val === '' || val === null || val === undefined) {
                                if (sel) { sel.value = ''; if (other) { other.style.display = 'none'; other.value = ''; } }
                            } else {
                                // custom value -> set select to __other__ and show other input with value
                                if (sel) sel.value = '__other__';
                                if (other) { other.style.display = 'inline-block'; other.value = val; }
                            }
                        } else if (CHOICES[field]) {
                            if (el && data[day][field] !== undefined) el.value = data[day][field];
                        } else if (field.toUpperCase() === 'REMARKS') {
                            if (el && data[day][field] !== undefined) el.value = data[day][field];
                        } else {
                            if (el && data[day][field] !== undefined) el.value = data[day][field];
                        }
                    });
                });
            }
            const savedProps = localStorage.getItem('properties');
            if (savedProps) {
                const props = JSON.parse(savedProps);
                props.forEach((prop, index) => { if (PROPERTIES[index]) Object.assign(PROPERTIES[index], prop); });
                loadPropertyInfo();
            }
        }

        // Remove clearMonth UI; no direct UI to clear month per request
        function exportData() {
            const allData = { exportDate: new Date().toISOString(), properties: PROPERTIES, readings: {} };
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('pool') || key === 'properties')) {
                    try { allData.readings[key] = JSON.parse(localStorage.getItem(key)); } catch (e) { allData.readings[key] = localStorage.getItem(key); }
                }
            }
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aquatic-maintenance-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('üì• Data exported successfully!');
        }

        function viewQRCodes() { window.open('qr-codes.html', '_blank'); }
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.display = 'block';
            setTimeout(() => { notif.style.display = 'none'; }, 3000);
        }

        // auto-save
        setInterval(() => { saveData(); }, 60000);

        // initialize
        init();
    </script>
</body>
</html>
